<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Base64 File Transfer</title>

<style>
body { font-family: Arial; margin: 40px; }
button { padding: 6px 12px; margin-left: 6px; }
.fileRow { margin: 4px 0; }

#log {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    height: 120px;
    overflow-y: auto;
}
</style>
</head>

<body>

<h2>Upload File (Text Only)</h2>

<input type="file" id="fileInput">
<button onclick="upload()">Upload</button>

<h3>Stored Files</h3>
<div id="fileList"></div>

<h3>Log</h3>
<div id="log"></div>

<script>
const API = "/api";

function log(msg) {
    const box = document.getElementById("log");
    box.innerHTML += msg + "<br>";
    box.scrollTop = box.scrollHeight;
}

function listFiles() {
    fetch(API + "/files")
        .then(r => r.json())
        .then(files => {
            const container = document.getElementById("fileList");
            container.innerHTML = "";

            files.forEach(name => {
                const row = document.createElement("div");
                row.className = "fileRow";

                const link = document.createElement("a");
                link.href = API + "/download/" + name;
                link.textContent = name;

                const del = document.createElement("button");
                del.textContent = "Delete";
                del.onclick = () => deleteFile(name);

                row.appendChild(link);
                row.appendChild(del);
                container.appendChild(row);
            });
        })
        .catch(() => log("Error loading file list"));
}

function upload() {
    const file = document.getElementById("fileInput").files[0];

    if (!file) {
        log("No file selected");
        return;
    }

    if (file.size > 30 * 1024 * 1024) {
        log("File too large");
        return;
    }

    log("Converting file to Base64 in browser...");

    const reader = new FileReader();

    reader.onload = function () {
        const base64Text = reader.result.split(',')[1];

        log("Uploading text to server...");

        fetch(API + "/upload", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                filename: file.name,
                data: base64Text
            })
        })
        .then(r => r.json())
        .then(resp => {
            if (resp.error) {
                log("Upload error: " + resp.error);
            } else {
                log("Upload finished successfully");
                listFiles();
            }
        })
        .catch(() => log("Upload failed"));
    };

    reader.readAsDataURL(file);
}

function deleteFile(name) {
    fetch(API + "/delete/" + name, { method: "DELETE" })
        .then(r => r.json())
        .then(resp => {
            if (resp.error) {
                log("Delete failed: " + resp.error);
            } else {
                log("Deleted: " + name);
                listFiles();
            }
        })
        .catch(() => log("Delete error"));
}

listFiles();
</script>

</body>
</html>
